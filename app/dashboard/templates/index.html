<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>WAF Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
    h2 { margin-top: 0; color: #555; }
    canvas { max-height: 400px; }
    #logs { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; max-height: 400px; }
    .charts-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 1200px) { .charts-container { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>WAF Dashboard</h1>
  
  <div class="charts-container">
    <section>
      <h2>Traffic Over Time</h2>
      <canvas id="trafficChart"></canvas>
    </section>
    
    <section>
      <h2>Allowed vs Blocked Requests</h2>
      <canvas id="decisionChart"></canvas>
    </section>
    
    <section>
      <h2>Attack Type Distribution</h2>
      <canvas id="attackChart"></canvas>
    </section>
    
    <section>
      <h2>Top IP Offenders</h2>
      <canvas id="ipChart"></canvas>
    </section>
  </div>
  
  <section>
    <h2>Recent Logs</h2>
    <pre id="logs"></pre>
  </section>
  
  <script>
    async function loadMetrics() {
      const res = await fetch('/dashboard/metrics');
      return res.json();
    }
    
    async function loadTraffic() {
      const res = await fetch('/dashboard/traffic');
      return res.json();
    }
    
    async function loadAttacks() {
      const res = await fetch('/dashboard/attacks');
      return res.json();
    }
    
    async function loadTopIPs() {
      const res = await fetch('/dashboard/top_ips');
      return res.json();
    }
    
    async function loadLogs() {
      const res = await fetch('/dashboard/logs');
      return res.json();
    }
    
    async function render() {
      const metrics = await loadMetrics();
      const traffic = await loadTraffic();
      const attacks = await loadAttacks();
      const topIPs = await loadTopIPs();
      const logs = await loadLogs();
      
      const decisionCtx = document.getElementById('decisionChart');
      const decisionLabels = Object.keys(metrics.counts || {});
      const decisionData = decisionLabels.map(l => metrics.counts[l]);
      new Chart(decisionCtx, {
        type: 'bar',
        data: {
          labels: decisionLabels,
          datasets: [{
            label: 'Requests',
            data: decisionData,
            backgroundColor: ['rgba(75,192,192,0.5)', 'rgba(255,99,132,0.5)']
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });
      
      const trafficCtx = document.getElementById('trafficChart');
      const trafficLabels = traffic.data.map(d => d.time);
      const trafficData = traffic.data.map(d => d.count);
      new Chart(trafficCtx, {
        type: 'line',
        data: {
          labels: trafficLabels,
          datasets: [{
            label: 'Requests',
            data: trafficData,
            borderColor: 'rgba(54,162,235,1)',
            backgroundColor: 'rgba(54,162,235,0.1)',
            tension: 0.1
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });
      
      const attackCtx = document.getElementById('attackChart');
      const attackLabels = Object.keys(attacks.data || {});
      const attackData = attackLabels.map(l => attacks.data[l]);
      new Chart(attackCtx, {
        type: 'doughnut',
        data: {
          labels: attackLabels,
          datasets: [{
            label: 'Attacks',
            data: attackData,
            backgroundColor: [
              'rgba(255,99,132,0.5)',
              'rgba(255,159,64,0.5)',
              'rgba(255,205,86,0.5)',
              'rgba(75,192,192,0.5)',
              'rgba(54,162,235,0.5)',
              'rgba(153,102,255,0.5)'
            ]
          }]
        },
        options: { responsive: true, maintainAspectRatio: true }
      });
      
      const ipCtx = document.getElementById('ipChart');
      const ipLabels = Object.keys(topIPs.data || {});
      const ipData = ipLabels.map(l => topIPs.data[l]);
      new Chart(ipCtx, {
        type: 'bar',
        data: {
          labels: ipLabels,
          datasets: [{
            label: 'Blocked Requests',
            data: ipData,
            backgroundColor: 'rgba(255,99,132,0.5)'
          }]
        },
        options: { responsive: true, maintainAspectRatio: true, indexAxis: 'y' }
      });
      
      document.getElementById('logs').textContent = JSON.stringify(logs, null, 2);
    }
    
    render();
    setInterval(render, 5000);
  </script>
</body>
</html>

